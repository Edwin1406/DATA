<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Descargar Consumo General</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Exportar datos de Consumo General</h2>
  <button id="btnDescargar">üì• Descargar Excel</button>

  <script>
async function fetchTodosLosDatos() {
  let pagina = 1;
  let todos = [];
  let seguir = true;

  while (seguir) {
    const response = await fetch(`https://pruebas.megawebsistem.com/admin/api/apiConsumoGeneral?page=${pagina}`);
    const data = await response.json();

    let registros = [];
    if (Array.isArray(data)) {
      registros = data;
    } else if (data.data && Array.isArray(data.data)) {
      registros = data.data;
    } else if (data.records && Array.isArray(data.records)) {
      registros = data.records;
    }

    if (registros.length === 0) {
      seguir = false;
    } else {
      todos = todos.concat(registros);
      pagina++;
    }
  }

  return todos;
}

document.getElementById("btnDescargar").addEventListener("click", async () => {
  try {
    const registros = await fetchTodosLosDatos();

    if (registros.length === 0) {
      alert("‚ö† No se encontraron datos en la API.");
      return;
    }

    const worksheet = XLSX.utils.json_to_sheet(registros);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Consumo");

    XLSX.writeFile(workbook, "consumo_general.xlsx");
  } catch (error) {
    console.error("Error al generar Excel:", error);
    alert("‚ùå Hubo un error al descargar el archivo.");
  }
});
</script>

</body>
</html>
